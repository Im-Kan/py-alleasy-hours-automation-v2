<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Automação planilhas AllEasy</title>
  </head>
  <style>
    html * {
      color: #e1e5e9 !important;
      font-family: sans-serif !important;
    }
    body {
      background-color: #10151a;
    }
    a {
      color: #d1d5d9;
    }
    .title {
      text-align: center;
    }
    .main {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .tutorial-txt {
      max-width: 550px;
      padding: 25px;
    }
    .images {
      padding: 20px;
    }
    .hidden {
      display: none;
    }
    .download {
      border-radius: 40px;
      background-color: white;
      color: #00626b !important;
      font-weight: bold;
      cursor: pointer;
      padding: 7px;
      border: none;
    }
    .submit {
      cursor: pointer;
    }
    img {
      object-fit: contain;
    }
    input, select {
      color: #008879 !important;
    }
  </style>
  <body onload="initialize();">
    <h1 class="title">Automação planilhas AllEasy</h1>
    <div class="main">
      <form id="myForm">
        <label for="fileInput">Xlsx do times explorer:</label>
        <input required type="file" id="fileInput" name="fileInput" /><br /><br />

        <label for="name">Nome completo:</label><br />
        <input required type="text" id="name" name="name"></textarea
        ><br /><br />

        <label for="month">Mês:</label>
        <select class="month" id="month" name="selectField">
        </select><br /><br />

        <label for="year">Ano:</label>
        <select id="year" name="year">
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
        </select><br /><br />

        <input class="submit" type="submit" value="Submit" />
      </form>

      <button id="downloadButton", class="download hidden">Baixar planilha</button>

      <div class="tutorial-txt">
        <h2>Como utilizar:</h2> <br />
        1. Baixar o excel do Times Explorer que é exportado no 7pacetimetracker
        (Plugin do devops);
        <div class="images">
          <img width="200" src="https://i.ibb.co/936mC9M/img0.png" />
          <img width="470" src="https://i.ibb.co/cgF10SN/img1.png" />
        </div>

        2. Verificar se está pegando a data correta:

        3. Verificar se a planilha contém exatamente as colunas abaixo nessa ordem:

        4. Caso contrário, alterar da seguinte forma:

        5. Colocar seu nome completo no campo e data; <br />
        6. Após clicar em executar automação, basta aguardar alguns segundos e clicar no botão de download que aparecerá.
      </div>
    </div>
  </body>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
  <script>

    function pad(d) {
        return (d < 10) ? '0' + d.toString() : d.toString();
    }

    function initialize() {
      const months = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEC'];
      const monthField = document.querySelector('.month');
      months.forEach((element, index) => {
        monthField.innerHTML += `<option value="${pad(index+1)}">${element}</option>`
      });
    };

    async function getBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });
    }

    let form = document.getElementById("myForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const rawFile = document.getElementById('fileInput').files[0];
      const name = document.getElementById('name').value;
      const date = document.getElementById('month').value + '/' + document.getElementById('year').value;

      var base64file = await getBase64(rawFile);
      console.log({name, date});

      resultBase64 = ""
      //----------Fazer request pra API---------.then
      await $.ajax({
        url : 'convert/',
        //csrfmiddlewaretoken : csrf_token, // from the template
        type : 'POST',
        data : {
        'base64' : base64file,
        'name':name,
        'date':date
        },
          success : (data)=>{resultBase64 = data} // reference to function below:
      })

      if(resultBase64 == "") {
        alert("deu erro kkk af")
        return
      }

      const blob = base64ToBlob(resultBase64, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
      console.log('aq')
      const blobUrl = URL.createObjectURL(blob);

      const downloadButton = document.getElementById('downloadButton');
      downloadButton.classList.remove("hidden");
      downloadButton.addEventListener('click', function() {
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = blobUrl;
        a.download = 'planilha-de-horas.xlsx';

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    });

    function base64ToBlob(base64, mimeType = '') {
      const byteCharacters = window.atob(base64);
      const byteNumbers = Array.from(byteCharacters).map(char => char.charCodeAt(0));
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], {type: mimeType});
    }
  </script>
</html>
